<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mario Platformer</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            margin: 0; background: #000; color: white;
            display: flex; flex-direction: column; align-items: center; 
            height: 100vh; font-family: Arial, sans-serif; overflow: hidden;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }
        #game-container {
            position: relative; width: 100vw; height: 60vh; max-width: 800px;
            background: #5C94FC; border-bottom: 4px solid #fff;
        }
        canvas { width: 100%; height: 100%; display: block; }
        #ui { 
            position: absolute; top: 10px; left: 10px; 
            font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; z-index: 10;
        }
        /* Mobile Touch Controls Area */
        #controls {
            width: 100%; height: 40vh; background: #222;
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
            gap: 10px; padding: 10px; box-sizing: border-box;
        }
        .touch-btn {
            background: #444; border: 4px solid #fff; border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; font-weight: bold;
            -webkit-tap-highlight-color: transparent;
        }
        .touch-btn:active { background: #777; }
        #btnJump { grid-column: 1 / span 2; background: #e74c3c; } 
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        LVL: <span id="lvl">1</span> | SCORE: <span id="score">0</span> | KEYS: <span id="keys">0</span>/<span id="keyTotal">0</span>
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
</div>

<div id="controls">
    <div class="touch-btn" id="btnJump">JUMP</div>
    <div class="touch-btn" id="btnLeft">LEFT</div>
    <div class="touch-btn" id="btnRight">RIGHT</div>
</div>

<script>
    // Initialize Telegram
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Game Config
    const gravity = 0.8;
    const worldWidth = 2400;  
    const worldHeight = 1000; 
    let currentLevel = 0;
    let score = 0;
    let keysCollected = 0;
    let gameState = "playing";

    const player = {
        x: 100, y: 800, w: 32, h: 44,
        dx: 0, dy: 0, speed: 6, jumpPower: -17,
        grounded: false, facing: 1
    };

    const camera = { x: 0, y: 0 };

    // --- 3 LEVELS DATA ---
    const levels = [
        { sky: "#5C94FC", brick: "#A52A2A", totalKeys: 2, platforms: [{x:0,y:950,w:900,h:50},{x:1100,y:950,w:1300,h:50},{x:300,y:800,w:150,h:30},{x:600,y:650,w:150,h:30}], enemies: [{x:500,y:918,w:32,h:32,speed:2,minX:300,maxX:800,active:true}], coins: [{x:350,y:760}], keys: [{x:350,y:760},{x:650,y:610}], goal: {x:2200,y:850,w:60,h:100} },
        { sky: "#202040", brick: "#404060", totalKeys: 3, platforms: [{x:0,y:950,w:600,h:50},{x:700,y:800,w:300,h:30},{x:1100,y:650,w:300,h:30},{x:1500,y:500,w:300,h:30},{x:1900,y:500,w:500,h:500}], enemies: [{x:1150,y:618,w:32,h:32,speed:3,minX:1100,maxX:1350,active:true}], coins: [{x:750,y:760}], keys: [{x:750,y:760},{x:1150,y:610},{x:2000,y:460}], goal: {x:2250,y:400,w:60,h:100} },
        { sky: "#FF4500", brick: "#333333", totalKeys: 3, platforms: [{x:0,y:950,w:500,h:50},{x:700,y:950,w:1700,h:50},{x:300,y:800,w:100,h:30},{x:500,y:650,w:100,h:30},{x:800,y:550,w:200,h:30},{x:1200,y:450,w:200,h:30}], enemies: [{x:900,y:918,w:32,h:32,speed:5,minX:800,maxX:1300,active:true}], coins: [{x:850,y:510}], keys: [{x:500,y:610},{x:1250,y:410},{x:2200,y:910}], goal: {x:2200,y:850,w:60,h:100} }
    ];

    let currentLevelData;

    function loadLevel(index) {
        currentLevelData = JSON.parse(JSON.stringify(levels[index])); 
        player.x = 100; player.y = 800; player.dx = 0; player.dy = 0;
        keysCollected = 0;
        document.getElementById("lvl").innerText = index + 1;
        document.getElementById("keyTotal").innerText = currentLevelData.totalKeys;
    }
    loadLevel(currentLevel);

    // --- TOUCH INPUT SYSTEM ---
    const keysDown = { left: false, right: false, jump: false };

    function bindTouch(id, action) {
        const el = document.getElementById(id);
        const start = (e) => { e.preventDefault(); keysDown[action] = true; };
        const end = (e) => { e.preventDefault(); keysDown[action] = false; };
        el.addEventListener("touchstart", start);
        el.addEventListener("touchend", end);
        el.addEventListener("touchcancel", end);
        // Also support Mouse for testing
        el.addEventListener("mousedown", start);
        el.addEventListener("mouseup", end);
    }

    bindTouch("btnLeft", "left");
    bindTouch("btnRight", "right");
    bindTouch("btnJump", "jump");

    // Keyboard fallback
    window.addEventListener("keydown", e => {
        if(e.code === "ArrowLeft") keysDown.left = true;
        if(e.code === "ArrowRight") keysDown.right = true;
        if(e.code === "Space") keysDown.jump = true;
    });
    window.addEventListener("keyup", e => {
        if(e.code === "ArrowLeft") keysDown.left = false;
        if(e.code === "ArrowRight") keysDown.right = false;
        if(e.code === "Space") keysDown.jump = false;
    });

    // --- GAME ENGINE ---
    function update() {
        if (gameState !== "playing") return;

        if (keysDown.right) { player.dx = player.speed; player.facing = 1; }
        else if (keysDown.left) { player.dx = -player.speed; player.facing = -1; }
        else { player.dx = 0; }

        if (keysDown.jump && player.grounded) {
            player.dy = player.jumpPower;
            player.grounded = false;
        }

        player.dy += gravity; player.x += player.dx; player.y += player.dy;

        // Collision
        player.grounded = false;
        currentLevelData.platforms.forEach(p => {
            if (player.x < p.x + p.w && player.x + player.w > p.x && 
                player.y < p.y + p.h && player.y + player.h > p.y) {
                if (player.dy > 0 && player.y + player.h - player.dy <= p.y) {
                    player.y = p.y - player.h; player.dy = 0; player.grounded = true;
                }
            }
        });

        // Enemies
        currentLevelData.enemies.forEach(en => {
            if (!en.active) return;
            en.x += en.speed;
            if (en.x < en.minX || en.x > en.maxX) en.speed *= -1;
            if (player.x < en.x + en.w && player.x + player.w > en.x && player.y < en.y + en.h && player.y + player.h > en.y) {
                if (player.dy > 0 && player.y + player.h < en.y + en.h/2 + player.dy) {
                    en.active = false; player.dy = -12; score += 100;
                } else { loadLevel(currentLevel); }
            }
        });

        // Items
        currentLevelData.coins.forEach(c => {
            if (!c.collected && player.x < c.x+20 && player.x+player.w > c.x && player.y < c.y+20 && player.y+player.h > c.y) {
                c.collected = true; score += 50;
            }
        });
        currentLevelData.keys.forEach(k => {
            if (!k.collected && player.x < k.x+20 && player.x+player.w > k.x && player.y < k.y+20 && player.y+player.h > k.y) {
                k.collected = true; keysCollected++;
            }
        });

        // Goal logic
        let g = currentLevelData.goal;
        if (player.x < g.x+g.w && player.x+player.w > g.x && player.y < g.y+g.h && player.y+player.h > g.y) {
            if (keysCollected >= currentLevelData.totalKeys) {
                if (currentLevel < levels.length - 1) { currentLevel++; loadLevel(currentLevel); }
                else gameState = "complete";
            }
        }

        if (player.y > worldHeight) loadLevel(currentLevel);

        document.getElementById("score").innerText = score;
        document.getElementById("keys").innerText = keysCollected;

        // Camera clamping
        camera.x = Math.max(0, Math.min(player.x - canvas.width / 2, worldWidth - canvas.width));
        camera.y = Math.max(0, Math.min(player.y - canvas.height / 2, worldHeight - canvas.height));
    }

    function draw() {
        ctx.fillStyle = currentLevelData.sky;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.save(); ctx.translate(-camera.x, -camera.y);

        // Bricks
        ctx.fillStyle = currentLevelData.brick;
        currentLevelData.platforms.forEach(p => { ctx.fillRect(p.x, p.y, p.w, p.h); ctx.strokeRect(p.x, p.y, p.w, p.h); });

        // Items
        ctx.fillStyle = "#FFD700"; currentLevelData.coins.forEach(c => { if(!c.collected) { ctx.beginPath(); ctx.arc(c.x+10, c.y+10, 10, 0, Math.PI*2); ctx.fill(); }});
        ctx.fillStyle = "#00FFFF"; currentLevelData.keys.forEach(k => { if(!k.collected) ctx.fillRect(k.x, k.y, 20, 20); });

        // Enemies
        currentLevelData.enemies.forEach(en => { if (en.active) { ctx.fillStyle = "#8B4513"; ctx.beginPath(); ctx.arc(en.x+16, en.y+12, 16, Math.PI, 0); ctx.fill(); ctx.fillStyle = "#FFCCAA"; ctx.fillRect(en.x+8, en.y+12, 16, 20); }});

        // Goal
        ctx.fillStyle = (keysCollected >= currentLevelData.totalKeys) ? "#FFD700" : "#555";
        ctx.fillRect(currentLevelData.goal.x, currentLevelData.goal.y, currentLevelData.goal.w, currentLevelData.goal.h);

        // Draw Mario
        ctx.fillStyle = "#0000FF"; ctx.fillRect(player.x + 5, player.y + 20, 22, 24); 
        ctx.fillStyle = "#FF0000"; ctx.fillRect(player.x + 5, player.y + 14, 22, 10); 
        ctx.fillStyle = "#FFCCAA"; ctx.fillRect(player.x + 8, player.y + 4, 16, 14); 
        ctx.fillStyle = "#FF0000"; ctx.fillRect(player.x + 5, player.y, 22, 6);   
        ctx.fillStyle = "black"; ctx.fillRect(player.facing === 1 ? player.x+20 : player.x+8, player.y+8, 4, 4);

        ctx.restore();

        if (gameState === "complete") {
            ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white"; ctx.font = "bold 30px Arial"; ctx.textAlign = "center";
            ctx.fillText("COURSE CLEAR!", canvas.width/2, canvas.height/2);
        }
    }

    function main() { update(); draw(); requestAnimationFrame(main); }
    main();
</script>
</body>
</html>